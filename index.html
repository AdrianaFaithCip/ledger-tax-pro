<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UF-Themed Tax-Aware Bookkeeping</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind UF Theme -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-blue': { 50:'#F0F2FA', 500:'#0021A5', 600:'#001D94', 700:'#001980', 800:'#00156B' },
            'brand-orange': { 50:'#FFF6F2', 500:'#FF4A00', 600:'#E04200', 700:'#C23900' },
            'success-dark': { 50:'#F0F9F7', 500:'#047857', 600:'#036647' },
            'warning-gold': { 50:'#FFFBF0', 500:'#D97706', 600:'#B45309' },
          }
        }
      }
    }
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Your Firebase config (keep this BEFORE the module script) -->
  <script src="./config.js"></script>

  <style>
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }
    .custom-scroll::-webkit-scrollbar-track { background:#f1f5f9; }
    #app-wrapper { height:100vh; display:flex; flex-direction:column; }
    #sidebar { width:100%; height:auto; border-bottom:1px solid #e2e8f0; }
    @media (min-width:768px) {
      #app-wrapper { flex-direction:row; }
      #sidebar { width:256px; height:100%; border-right:1px solid #e2e8f0; border-bottom:none; }
    }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal-overlay.open .modal-content { transform:scale(1); opacity:1; }
    .modal-content { transform:scale(.95); opacity:0; transition:all .2s ease-out; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased">
  <div id="app-wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="bg-white p-4 md:p-6 shadow-lg md:shadow-none flex flex-row md:flex-col justify-between items-center md:items-start z-10">
      <h1 class="text-2xl font-extrabold text-brand-blue-700 tracking-tight mb-4 hidden md:block">LedgerTax Pro</h1>
      <div class="flex flex-row md:flex-col gap-2 w-full md:w-auto">
        <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-btn bg-brand-orange-500 text-white flex items-center p-3 rounded-xl transition hover:bg-brand-orange-600 w-full justify-center md:justify-start">
          <i data-lucide="layout-dashboard" class="w-5 h-5 mr-0 md:mr-2"></i><span class="hidden md:inline">T-Accounts</span>
        </button>
        <button onclick="navigate('transactions')" id="nav-transactions" class="nav-btn text-gray-600 flex items-center p-3 rounded-xl transition hover:bg-gray-100 w-full justify-center md:justify-start">
          <i data-lucide="receipt-text" class="w-5 h-5 mr-0 md:mr-2"></i><span class="hidden md:inline">Journal Entries</span>
        </button>
        <button onclick="navigate('tax-report')" id="nav-tax-report" class="nav-btn text-gray-600 flex items-center p-3 rounded-xl transition hover:bg-gray-100 w-full justify-center md:justify-start">
          <i data-lucide="file-text" class="w-5 h-5 mr-0 md:mr-2"></i><span class="hidden md:inline">Taxable Income</span>
        </button>
        <button onclick="openSettings()" id="nav-settings" class="nav-btn text-gray-600 flex items-center p-3 rounded-xl transition hover:bg-gray-100 w-full justify-center md:justify-start">
          <i data-lucide="settings" class="w-5 h-5 mr-0 md:mr-2"></i><span class="hidden md:inline">Settings</span>
        </button>
      </div>
      <div id="user-info" class="mt-4 pt-4 border-t border-gray-100 hidden md:block">
        <p class="text-xs text-gray-500">User ID:</p>
        <code class="text-xs text-gray-700 break-all" id="display-user-id">Loading...</code>
      </div>
    </nav>

    <!-- Main -->
    <main id="content-area" class="flex-1 p-4 md:p-8 overflow-y-auto"></main>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal-overlay">
    <div id="settings-content" class="modal-content bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full"></div>
  </div>

  <!-- App -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------- Global State ----------
    let firebaseApp, db, auth;
    let userId = 'loading';
    let transactions = [];
    let currentView = 'dashboard';
    let accountingMethod = 'Accrual';
    let taxRate = 0.21;
    let isSettingsReady = false;

    const APP_COLLECTION = 'journal_entries';
    const SETTINGS_DOC = 'accounting';

    // Friendlier logs on prod
    setLogLevel('error');

    // --------- Double-Entry & Tags ----------
    const JOURNAL_ENTRIES = {
      'Invest': { description: "Owner invests cash", debit: "Cash", credit: "Owner's Capital", category: "Owner Equity", taxImpact: "None" },
      'CashSale': { description: "Cash sale for services/goods", debit: "Cash", credit: "Sales Revenue", category: "Sales & Revenue", taxImpact: "Revenue" },
      'CreditSale': { description: "Credit sale (on account)", debit: "Accounts Receivable", credit: "Sales Revenue", category: "Sales & Revenue", taxImpact: "Revenue" },
      'CollectAR': { description: "Customer payment on account", debit: "Cash", credit: "Accounts Receivable", category: "Receivable", taxImpact: "None" },
      'PaySupplier': { description: "Pay supplier for inventory/expenses", debit: "Accounts Payable", credit: "Cash", category: "Payable", taxImpact: "None" },
      'Rent': { description: "Pay for rent", debit: "Rent Expense", credit: "Cash", category: "Operating Expense", taxImpact: "Deductible Expense" },
      'Utilities': { description: "Pay for utilities", debit: "Utilities Expense", credit: "Cash", category: "Operating Expense", taxImpact: "Deductible Expense" },
      'SuppliesPurchase': { description: "Purchase supplies for cash", debit: "Supplies Expense", credit: "Cash", category: "Operating Expense", taxImpact: "Deductible Expense" },
      'EquipmentPurchase': { description: "Purchase Equipment (Capital Expenditure)", debit: "Equipment", credit: "Cash", category: "Fixed Asset", taxImpact: "Capital Expenditure" },
      'Drawings': { description: "Withdraw cash for personal use", debit: "Owner's Drawings", credit: "Cash", category: "Owner Equity", taxImpact: "None" },
    };

    const DEBIT_BALANCE_ACCOUNTS = [
      "Cash","Accounts Receivable","Inventory","Prepaid Insurance","Equipment",
      "Rent Expense","Utilities Expense","Supplies Expense","Salaries Expense","Advertising Expense",
      "Interest Expense","Owner's Drawings","Cost of Goods Sold"
    ];

    // ---------- Helpers ----------
    function getSettingsDocRef() {
      const appId = (window.APP_ID || 'ledger-tax-pro');
      return doc(db, `artifacts/${appId}/users/${userId}/settings/${SETTINGS_DOC}`);
    }
    function getTransactionCollectionRef() {
      const appId = (window.APP_ID || 'ledger-tax-pro');
      return collection(db, `artifacts/${appId}/users/${userId}/${APP_COLLECTION}`);
    }
    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US',{ style:'currency', currency:'USD', minimumFractionDigits:2 }).format(value);
    }

    async function loadSettings() {
      try {
        const snap = await getDoc(getSettingsDocRef());
        if (snap.exists()) {
          const data = snap.data();
          accountingMethod = data.method || 'Accrual';
          taxRate = data.taxRate ? Number(data.taxRate) : 0.21;
        } else {
          await saveSettings('Accrual', 0.21);
          accountingMethod = 'Accrual';
          taxRate = 0.21;
        }
      } catch (e) {
        console.error('loadSettings', e);
      } finally {
        isSettingsReady = true;
      }
    }

    async function saveSettings(method, rate) {
      const numericRate = parseFloat(rate);
      await setDoc(getSettingsDocRef(), { method, taxRate: numericRate });
      accountingMethod = method;
      taxRate = numericRate;
      showNotification(`Settings updated: ${method} Basis, ${(taxRate*100).toFixed(2)}% Tax.`, 'success');
    }

    function setupTransactionListener() {
      try {
        const q = query(getTransactionCollectionRef());
        onSnapshot(q, (snapshot) => {
          const list = [];
          snapshot.forEach((d) => {
            const data = d.data();
            list.push({
              id: d.id,
              ...data,
              amount: Number(data.amount),
              date: (data.date || '').toString().substring(0,10),
            });
          });
          list.sort((a,b) => new Date(b.date) - new Date(a.date));
          transactions = list;
          renderView(currentView);
        }, (err)=>console.error('onSnapshot', err));
      } catch (e) {
        console.error('setupTransactionListener', e);
      }
    }

    async function addTransaction(entry) {
      await addDoc(getTransactionCollectionRef(), {
        ...entry,
        date: entry.date || new Date().toISOString().substring(0,10),
        amount: Number(entry.amount)
      });
    }

    window.deleteTransaction = async (id) => {
      await deleteDoc(doc(getTransactionCollectionRef(), id));
      showNotification('Journal entry deleted.', 'success');
    }

    function showNotification(message, type) {
      const container = document.getElementById('app-wrapper').parentNode || document.body;
      let el = document.getElementById('app-notification');
      if (!el) {
        el = document.createElement('div');
        el.id = 'app-notification';
        el.className = 'fixed top-4 right-4 z-50 transition-opacity duration-300';
        container.appendChild(el);
      }
      const bg = type==='success' ? 'bg-success-dark-50 border-success-dark-500 text-success-dark-600'
                                  : 'bg-red-100 border-red-400 text-red-700';
      const icon = type==='success' ? '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>'
                                    : '<i data-lucide="x-circle" class="w-5 h-5 mr-2"></i>';
      el.innerHTML = `<div class="p-4 rounded-xl border shadow-lg flex items-center ${bg}">${icon}<span>${message}</span></div>`;
      lucide.createIcons();
      setTimeout(()=>{ el.innerHTML=''; }, 3000);
    }

    window.navigate = (view) => {
      currentView = view;
      document.querySelectorAll('.nav-btn').forEach(btn=>{
        btn.classList.remove('bg-brand-orange-500','text-white');
        btn.classList.add('text-gray-600','hover:bg-gray-100');
      });
      const active = document.getElementById(`nav-${view}`);
      if (active) {
        active.classList.add('bg-brand-orange-500','text-white');
        active.classList.remove('text-gray-600','hover:bg-gray-100');
      }
      renderView(view);
    };

    function renderView(view) {
      const area = document.getElementById('content-area');
      area.innerHTML = '';
      if (view==='dashboard') renderDashboard(area);
      else if (view==='transactions') renderTransactions(area);
      else if (view==='tax-report') renderTaxReport(area);
      else renderDashboard(area);
      lucide.createIcons();
    }

    function calculateAccountBalances() {
      const ledger = new Map();
      transactions.forEach(t=>{
        const amt = t.amount;
        ledger.set(t.debitAccount,  (ledger.get(t.debitAccount)  || 0) + amt);
        ledger.set(t.creditAccount, (ledger.get(t.creditAccount) || 0) - amt);
      });
      return ledger;
    }

    window.openSettings = function() {
      const modal = document.getElementById('settings-modal');
      const content = document.getElementById('settings-content');
      content.innerHTML = `
        <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
          <i data-lucide="settings" class="w-6 h-6 mr-2 text-brand-blue-500"></i> IRC Accounting Settings
        </h3>
        <form id="settings-form">
          <p class="text-sm text-gray-600 mb-6">Configure your mandatory tax accounting method and flat tax rate.</p>
          <div class="mb-6">
            <label class="block text-lg font-semibold text-gray-800 mb-2">Accounting Method</label>
            <div class="mt-2 space-y-4">
              <label class="flex items-center p-4 bg-gray-50 rounded-xl border border-gray-200 cursor-pointer hover:bg-success-dark-50 transition">
                <input type="radio" name="accountingMethod" value="Cash" class="h-5 w-5" ${accountingMethod==='Cash'?'checked':''}>
                <div class="ml-3">
                  <p class="text-sm font-medium text-gray-900">Cash Basis</p>
                  <p class="text-xs text-gray-500">Revenue when cash is received; expenses when cash is paid.</p>
                </div>
              </label>
              <label class="flex items-center p-4 bg-gray-50 rounded-xl border border-gray-200 cursor-pointer hover:bg-brand-blue-50 transition">
                <input type="radio" name="accountingMethod" value="Accrual" class="h-5 w-5" ${accountingMethod==='Accrual'?'checked':''}>
                <div class="ml-3">
                  <p class="text-sm font-medium text-gray-900">Accrual Basis</p>
                  <p class="text-xs text-gray-500">Revenue when earned; expenses when incurred.</p>
                </div>
              </label>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-lg font-semibold text-gray-800 mb-2" for="taxRateInput">Flat Tax Rate (0–1)</label>
            <input type="number" id="taxRateInput" name="taxRate" required step="0.01" min="0.00" max="1.00" value="${taxRate}"
              class="w-full p-2 border border-gray-300 rounded-xl focus:ring-brand-blue-500 focus:border-brand-blue-500 transition">
          </div>
          <div class="flex justify-end gap-3 pt-4 border-t mt-4">
            <button type="button" onclick="closeSettings()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition">Cancel</button>
            <button type="submit" class="px-6 py-2 bg-brand-orange-600 text-white font-semibold rounded-xl hover:bg-brand-orange-700 transition">Save Settings</button>
          </div>
        </form>`;
      lucide.createIcons();
      document.getElementById('settings-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const method = document.querySelector('input[name="accountingMethod"]:checked').value;
        const rate   = document.getElementById('taxRateInput').value;
        saveSettings(method, rate).finally(closeSettings);
      });
      modal.classList.add('open');
      modal.style.display = 'flex';
    };
    window.closeSettings = function() {
      const modal = document.getElementById('settings-modal');
      modal.classList.remove('open');
      setTimeout(()=>{ modal.style.display='none'; renderView(currentView); }, 200);
    };

    function renderDashboard(container) {
      const balances = calculateAccountBalances();
      const rows = Array.from(balances.entries())
        .filter(([n,v])=>Math.abs(v)>0.005)
        .map(([name, balance])=>{
          const isDebit = DEBIT_BALANCE_ACCOUNTS.includes(name);
          let balanceType = 'Debit';
          let displayBalance = balance;
          let textColor = 'text-success-dark-600';
          if (!isDebit) { balanceType='Credit'; displayBalance = -balance; textColor='text-brand-blue-600'; }
          if (balance < 0 && isDebit) textColor = 'text-red-600';
          if (balance > 0 && !isDebit) { textColor='text-red-600'; balanceType='Debit'; displayBalance=balance; }
          return { name, balance:displayBalance, balanceType, textColor };
        });

      const cash = rows.find(r=>r.name==='Cash');
      container.innerHTML = `
        <div class="max-w-6xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
            <i data-lucide="scale" class="w-6 h-6 mr-2 text-brand-blue-500"></i> General Ledger Balances (T-Accounts)
          </h2>
          <div class="p-3 mb-6 rounded-xl border-l-4 ${accountingMethod==='Accrual' ? 'border-brand-blue-500 bg-brand-blue-50' : 'border-success-dark-500 bg-success-dark-50'}">
            <p class="text-sm font-semibold text-gray-800">Accounting Method: <span class="font-extrabold">${accountingMethod} Basis</span></p>
            <p class="text-xs text-gray-600">This affects how income is recognized on your tax report (§451).</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-success-dark-500">
              <p class="text-sm font-medium text-gray-500">Cash Balance</p>
              <p class="mt-1 text-3xl font-extrabold ${cash ? cash.textColor : 'text-gray-400'}">${cash ? formatCurrency(cash.balance) : formatCurrency(0)}</p>
              <span class="text-xs text-gray-400">${cash ? cash.balanceType : 'No entries'}</span>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-warning-gold-500">
              <p class="text-sm font-medium text-gray-500">Accounts Receivable</p>
              ${(ar=>`
                <p class="mt-1 text-3xl font-extrabold ${ar ? ar.textColor : 'text-gray-400'}">${ar ? formatCurrency(ar.balance) : formatCurrency(0)}</p>
                <span class="text-xs text-gray-400">${ar ? ar.balanceType : 'No entries'}</span>
              `)(rows.find(a=>a.name==='Accounts Receivable'))}
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-red-500">
              <p class="text-sm font-medium text-gray-500">Equipment (Asset Basis)</p>
              ${(eq=>`
                <p class="mt-1 text-3xl font-extrabold ${eq ? 'text-red-600' : 'text-gray-400'}">${eq ? formatCurrency(eq.balance) : formatCurrency(0)}</p>
                <span class="text-xs text-gray-400">Capital Basis (§1012)</span>
              `)(rows.find(a=>a.name==='Equipment'))}
            </div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Detailed Account Balances</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Account</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Nature</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Balance</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                  ${rows.map(a=>`
                    <tr class="hover:bg-gray-50 transition">
                      <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${a.name}</td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-right">
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${a.balanceType==='Debit' ? 'bg-success-dark-100 text-success-dark-700' : 'bg-brand-blue-100 text-brand-blue-700'}">${a.balanceType}</span>
                      </td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-right ${a.textColor}">${formatCurrency(a.balance)}</td>
                    </tr>
                  `).join('')}
                  ${rows.length===0 ? `<tr><td colspan="3" class="text-center py-6 text-gray-500">No journal entries recorded to calculate balances.</td></tr>` : ''}
                </tbody>
              </table>
            </div>
          </div>
        </div>`;
    }

    function renderTransactions(container) {
      const entryOptions = Object.entries(JOURNAL_ENTRIES).map(([key, val])=>`
        <option value="${key}">${val.description} (Dr: ${val.debit} / Cr: ${val.credit})</option>
      `).join('');
      container.innerHTML = `
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 sticky top-0">
              <h3 class="text-xl font-bold text-gray-900 mb-6">Record New Journal Entry</h3>
              <form id="add-transaction-form">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="journalType">Journal Entry Type</label>
                  <select id="journalType" name="journalType" required class="w-full p-2 border border-gray-300 rounded-xl focus:ring-brand-blue-500 focus:border-brand-blue-500 transition">
                    <option value="" disabled selected>Select a Transaction Type</option>
                    ${entryOptions}
                  </select>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="date">Date</label>
                  <input type="date" id="date" name="date" required value="${new Date().toISOString().substring(0,10)}" class="w-full p-2 border border-gray-300 rounded-xl focus:ring-brand-blue-500 focus:border-brand-blue-500 transition">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="description">Memo / Detail</label>
                  <input type="text" id="description" name="description" required placeholder="Add details (e.g., paid rent for Oct)" class="w-full p-2 border border-gray-300 rounded-xl focus:ring-brand-blue-500 focus:border-brand-blue-500 transition">
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="amount">Amount (USD)</label>
                  <input type="number" id="amount" name="amount" required step="0.01" min="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-xl focus:ring-brand-blue-500 focus:border-brand-blue-500 transition">
                </div>
                <button type="submit" class="w-full bg-brand-orange-600 text-white font-semibold p-3 rounded-xl hover:bg-brand-orange-700 transition shadow-md">
                  <i data-lucide="sheet" class="w-5 h-5 inline mr-2"></i> Post Journal Entry
                </button>
              </form>
            </div>
          </div>
          <div class="lg:col-span-2">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">General Journal (${transactions.length} Entries)</h2>
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 h-[70vh] custom-scroll overflow-y-auto">
              <div class="p-2 border-b border-gray-200 bg-gray-50 flex items-center justify-between font-semibold text-sm text-gray-700 sticky top-0">
                <span class="w-1/4">Date / Memo</span>
                <span class="w-1/4">Debit Account</span>
                <span class="w-1/4 text-right">Credit Account</span>
                <span class="w-1/4 text-right pr-12">Amount</span>
                <span class="w-12"></span>
              </div>
              <ul id="transaction-list" class="divide-y divide-gray-100">
                ${transactions.length>0 ? transactions.map(t=>`
                  <li class="flex items-start justify-between p-4 hover:bg-gray-50 transition">
                    <div class="w-1/4 min-w-0 pr-2">
                      <p class="text-xs text-gray-500 mb-1">${t.date}</p>
                      <p class="font-medium text-gray-800">${t.description}</p>
                    </div>
                    <div class="w-1/4 min-w-0 pr-2">
                      <p class="text-sm font-semibold text-success-dark-600 flex items-center">
                        <i data-lucide="arrow-up-right" class="w-3 h-3 mr-1"></i> ${t.debitAccount}
                      </p>
                      <p class="text-xs text-gray-400">${t.taxImpact || 'N/A'}</p>
                    </div>
                    <div class="w-1/4 min-w-0 pr-2 text-right">
                      <p class="text-sm font-semibold text-brand-blue-600 flex items-center justify-end">
                        <i data-lucide="arrow-down-left" class="w-3 h-3 mr-1"></i> ${t.creditAccount}
                      </p>
                    </div>
                    <div class="w-1/4 text-right pr-4">
                      <p class="font-bold text-gray-900">${formatCurrency(t.amount)}</p>
                    </div>
                    <button onclick="deleteTransaction('${t.id}')" class="w-12 p-2 text-gray-400 hover:text-red-500 transition rounded-full hover:bg-red-50" title="Delete Entry">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </li>
                `).join('') : `
                  <li class="p-8 text-center text-gray-500">
                    <i data-lucide="book-open-text" class="w-10 h-10 mx-auto mb-2 text-gray-300"></i>
                    <p>Your general journal is empty. Start posting entries!</p>
                  </li>`}
              </ul>
            </div>
          </div>
        </div>`;
      document.getElementById('add-transaction-form').addEventListener('submit', handleAddTransaction);
    }

    function handleAddTransaction(e) {
      e.preventDefault();
      const f = e.target;
      const key = f.journalType.value;
      const rule = JOURNAL_ENTRIES[key];
      if (!rule) return showNotification('Invalid journal entry type.', 'error');

      const amount = parseFloat(f.amount.value);
      if (isNaN(amount) || amount <= 0) return showNotification('Enter a valid amount > 0.', 'error');

      const entry = {
        journalType: key,
        date: f.date.value,
        description: f.description.value.trim(),
        amount,
        debitAccount: rule.debit,
        creditAccount: rule.credit,
        taxImpact: rule.taxImpact
      };
      addTransaction(entry).then(()=>{
        showNotification('Journal entry posted!', 'success');
        f.date.value = new Date().toISOString().substring(0,10);
        f.description.value = '';
        f.amount.value = '';
      }).catch(err=>{
        console.error('addTransaction', err);
        showNotification('Failed to save journal entry.', 'error');
      });
    }

    function renderTaxReport(container) {
      const taxAggregates = { Revenue:0, DeductibleExpense:0, CapitalExpenditure:0, None:0 };
      transactions.forEach(t=>{
        const impact = t.taxImpact || 'None';
        const amt = t.amount;
        if (impact==='Revenue')               taxAggregates.Revenue += amt;
        else if (impact==='Deductible Expense') taxAggregates.DeductibleExpense += amt;
        else if (impact==='Capital Expenditure') taxAggregates.CapitalExpenditure += amt;
      });

      const grossIncome = taxAggregates.Revenue;
      const totalDeductions = taxAggregates.DeductibleExpense;
      const taxableNetIncome = grossIncome - totalDeductions;
      const taxLiability = taxableNetIncome > 0 ? taxableNetIncome * taxRate : 0;
      const netProfitAfterTax = taxableNetIncome - taxLiability;

      container.innerHTML = `
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
            <i data-lucide="file-text" class="w-6 h-6 mr-2 text-brand-blue-500"></i> Taxable Income Report
          </h2>
          <div class="p-3 mb-6 rounded-xl border-l-4 ${accountingMethod==='Accrual' ? 'border-brand-blue-500 bg-brand-blue-50' : 'border-success-dark-500 bg-success-dark-50'}">
            <p class="text-sm font-semibold text-gray-800">Accounting Method for Income Recognition: <span class="font-extrabold">${accountingMethod} Basis (§451)</span></p>
            <p class="text-xs text-gray-600">The report reflects revenue/expense recognition based on this method.</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Gross Income (§61)</h3>
            <div class="flex justify-between items-center py-2 border-b border-dashed">
              <span class="font-medium text-gray-700 pl-4">Sales Revenue (Taxable)</span>
              <span class="font-semibold text-lg text-success-dark-600">${formatCurrency(grossIncome)}</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-brand-blue-200 mb-6">
              <span class="font-extrabold text-lg text-brand-blue-800">TOTAL GROSS INCOME</span>
              <span class="font-extrabold text-xl text-brand-blue-800">${formatCurrency(grossIncome)}</span>
            </div>

            <h3 class="text-2xl font-semibold text-gray-800 mt-6 mb-4">Deductible Expenses (§162(a))</h3>
            <div class="space-y-1">
              ${transactions.filter(t=>t.taxImpact==='Deductible Expense').map(t=>`
                <div class="flex justify-between items-center py-1 border-b border-dashed">
                  <span class="text-gray-600 pl-4">${t.debitAccount} (via: ${t.description})</span>
                  <span class="text-red-600">${formatCurrency(t.amount)}</span>
                </div>`).join('')}
              ${totalDeductions===0 ? '<p class="text-center text-gray-500 py-4">No deductible expenses recorded.</p>' : ''}
            </div>
            <div class="flex justify-between items-center py-2 border-b border-red-200 mt-4 mb-6">
              <span class="font-extrabold text-lg text-red-800">TOTAL DEDUCTIONS</span>
              <span class="font-extrabold text-xl text-red-800">${formatCurrency(totalDeductions)}</span>
            </div>

            <div class="flex justify-between items-center py-4 bg-gray-50 rounded-lg p-4 shadow-inner">
              <span class="font-extrabold text-xl text-gray-900">TAXABLE NET INCOME / (LOSS)</span>
              <span class="font-extrabold text-2xl ${taxableNetIncome>=0?'text-success-dark-700':'text-red-700'}">${formatCurrency(taxableNetIncome)}</span>
            </div>

            <h3 class="text-2xl font-semibold text-gray-800 mt-8 mb-4 border-t pt-4">Tax Computation (§11)</h3>
            <div class="space-y-3">
              <div class="flex justify-between items-center py-2 border-b border-dashed bg-gray-50 p-2 rounded-md">
                <span class="font-bold text-gray-700 pl-4">Applicable Tax Rate (From Settings)</span>
                <span class="font-bold text-lg text-brand-blue-700">${(taxRate*100).toFixed(2)}%</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-brand-orange-200">
                <span class="font-extrabold text-lg text-brand-orange-800">TAX LIABILITY DUE</span>
                <span class="font-extrabold text-xl ${taxLiability>0?'text-red-700':'text-gray-500'}">(${formatCurrency(taxLiability)})</span>
              </div>
            </div>

            <div class="flex justify-between items-center py-4 mt-6 bg-brand-blue-50 rounded-lg p-4 shadow-xl border-t-4 border-brand-blue-500">
              <span class="font-extrabold text-2xl text-gray-900">NET PROFIT AFTER TAX</span>
              <span class="font-extrabold text-3xl ${netProfitAfterTax>=0?'text-success-dark-700':'text-red-700'}">${formatCurrency(netProfitAfterTax)}</span>
            </div>

            <div class="mt-8 p-4 bg-warning-gold-50 border-l-4 border-warning-gold-500 rounded-lg">
              <p class="font-semibold text-lg text-gray-800 mb-1">Capital Expenditures Disclosure (§263(a))</p>
              <div class="flex justify-between items-center text-sm">
                <span class="text-gray-700">Total Asset Basis Recognized:</span>
                <span class="font-bold">${formatCurrency(taxAggregates.CapitalExpenditure)}</span>
              </div>
              <p class="text-xs text-gray-600 mt-2">*Not immediately deductible; depreciate (§167-168) or consider §179/Bonus rules.</p>
            </div>
          </div>
        </div>`;
    }

    // ---------- Init ----------
    async function initFirebase() {
      const firebaseConfig = window.FIREBASE_CONFIG;
      if (!firebaseConfig || !firebaseConfig.apiKey) {
        const area = document.getElementById('content-area');
        area.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mt-4">
          <strong class="font-bold">Config Error:</strong>
          <span class="block sm:inline">Missing Firebase config. Edit <code>config.js</code>.</span>
        </div>`;
        throw new Error('Missing Firebase config');
      }
      firebaseApp = initializeApp(firebaseConfig);
      db = getFirestore(firebaseApp);
      auth = getAuth(firebaseApp);

      // Use Anonymous auth for GH Pages (no redirect needed)
      await signInAnonymously(auth);

      onAuthStateChanged(auth, async (user)=>{
        if (user) {
          userId = user.uid;
          const el = document.getElementById('display-user-id');
          if (el) el.textContent = userId;
          await loadSettings();
          setupTransactionListener();
          renderView(currentView);
        } else {
          userId = null;
          const el = document.getElementById('display-user-id');
          if (el) el.textContent = 'Error: Not Signed In';
        }
      });
    }

    window.onload = function() {
      initFirebase().catch(e=>console.error(e));
      navigate('dashboard');
    };
  </script>
</body>
</html>
